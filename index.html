<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Kalkulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{margin:0;height:100vh;background:#000;display:flex;justify-content:center;align-items:center;touch-action:manipulation;user-select:none;font-family:system-ui;}
  #calc{width:340px;background:#1c1c1c;padding:20px;border-radius:24px;box-shadow:0 15px 40px rgba(0,0,0,0.9);}
  #display{width:100%;height:100px;background:#000;color:#0f0;font-size:3em;text-align:right;padding:0 15px;border:none;border-radius:16px;margin-bottom:15px;box-sizing:border-box;}
  .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;}
  button{height:76px;font-size:2em;border:none;border-radius:18px;background:#333;color:#fff;font-weight:bold;}
  button:active{transform:scale(0.95);}
  button.op{background:#ff9500;}
  button.op:active{background:#cc7700;}
  button.zero{grid-column:span 2;}
  button.light{background:#a6a6a6;color:#000;}
  button.light:active{background:#888;}
  video{display:none;}
</style>
</head>
<body>

<div id="calc">
  <input type="text" id="display" value="0" readonly>
  <div class="row">
    <button class="light" data-key="C">C</button>
    <button class="light" data-key="+/-">+/-</button>
    <button class="light" data-key="%">%</button>
    <button class="op" data-key="/">÷</button>
  </div>
  <div class="row">
    <button data-key="7">7</button>
    <button data-key="8">8</button>
    <button data-key="9">9</button>
    <button class="op" data-key="*">×</button>
  </div>
  <div class="row">
    <button data-key="4">4</button>
    <button data-key="5">5</button>
    <button data-key="6">6</button>
    <button class="op" data-key="-">−</button>
  </div>
  <div class="row">
    <button data-key="1">1</button>
    <button data-key="2">2</button>
    <button data-key="3">3</button>
    <button class="op" data-key="+">+</button>
  </div>
  <div class="row">
    <button class="zero" data-key="0">0</button>
    <button data-key=".">,</button>
    <button class="op" data-key="=">=</button>
  </div>
</div>

<video id="cam" playsinline></video>

<script>
const disp = document.getElementById('display');
let val = '0', op = null, prev = null;
let stream = null;
let photoCount = parseInt(localStorage.getItem('spyCount') || '0');
const video = document.getElementById('cam');

function show(v) { disp.value = v; }

// ——— Kalkulator ———
function appendDigit(d) {
  val = val === '0' ? d : val + d;
  show(val);
}
function appendDot() {
  if (!val.includes('.')) { val += '.'; show(val); }
}
function clearAll() { val = '0'; op = null; prev = null; show('0'); }
function plusMinus() { val = val.startsWith('-') ? val.slice(1) : '-' + val; show(val); }
function percent() { val = (parseFloat(val) / 100).toString(); show(val); }
function setOperator(o) {
  if (prev !== null) calculate();
  prev = parseFloat(val);
  val = '0';
  op = o;
}
function calculate() {
  if (op === null || prev === null) return;
  const a = prev, b = parseFloat(val);
  if (op === '+') val = (a + b).toString();
  if (op === '-') val = (a - b).toString();
  if (op === '*') val = (a * b).toString();
  if (op === '/') val = b !== 0 ? (a / b).toString() : 'Error';
  op = null; prev = null;
  show(val);
}

// ——— Kamera (zapamiętuje pozwolenie) ———
async function getCamera() {
  if (stream) return stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    video.srcObject = stream;
    return stream;
  } catch(e) {
    show('NO CAMERA');
    setTimeout(() => show(val), 1000);
    return null;
  }
}

function takePhoto() {
  if (!stream) return;
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 1280;
  canvas.height = video.videoHeight || 720;
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  const data = canvas.toDataURL('image/jpeg', 0.8);

  photoCount++;
  localStorage.setItem('spyCount', photoCount);
  localStorage.setItem('spy_' + photoCount, data);

  show('ZROBIONO');
  setTimeout(() => show(val), 700);
}

async function downloadAll() {
  if (photoCount === 0) { show('Brak zdjęć'); setTimeout(() => show(val), 1000); return; }

  const zip = new JSZip();
  for (let i = 1; i <= photoCount; i++) {
    const img = localStorage.getItem('spy_' + i);
    if (img) zip.file(`photo_${i}.jpg`, img.split(',')[1], {base64: true});
  }
  const blob = await zip.generateAsync({type:"blob"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `photos_${Date.now()}.zip`; a.click();
  URL.revokeObjectURL(url);

  show('DOWN');
  setTimeout(() => show(val), 1000);
}

function deleteAll() {
  for (let i = 1; i <= photoCount; i++) localStorage.removeItem('spy_' + i);
  localStorage.setItem('spyCount', '0');
  photoCount = 0;
  show('USUNIĘTO');
  setTimeout(() => show(val), 1000);
}

// ——— Obsługa przycisków ———
document.querySelectorAll('button').forEach(btn => {
  const key = btn.dataset.key || btn.textContent.trim();
  let longPressTimer = null;
  let isLongPress = false;

  // Zawsze najpierw normalne działanie (kliknięcie)
  const normalAction = () => {
    if (isLongPress) return; // blokujemy jeśli trwa długie przytrzymanie

    if ('0123456789'.includes(key)) appendDigit(key);
    else if (key === '0') appendDigit('0');
    else if (key === ',') appendDot();
    else if (key === 'C') clearAll();
    else if (key === '+/-') plusMinus();
    else if (key === '%') percent();
    else if ('+-×÷'.includes(key)) {
      const map = {'×':'*', '÷':'/', '−':'-'};
      setOperator(map[key] || key);
    }
    else if (key === '=') calculate();
  };

  btn.addEventListener('click', normalAction);

  // Długie przytrzymanie tylko dla 7, 0 i C
  if (key === '7' || key === '0' || key === 'C') {
    const startLongPress = () => {
      isLongPress = false;
      longPressTimer = setTimeout(async () => {
        isLongPress = true;
        await getCamera(); // zapamiętuje pozwolenie
        if (key === '7') takePhoto();
        if (key === '0') downloadAll();
        if (key === 'C') deleteAll();
      }, 2500);
    };

    const cancelLongPress = () => {
      clearTimeout(longPressTimer);
    };

    btn.addEventListener('mousedown', startLongPress);
    btn.addEventListener('touchstart', e => { e.preventDefault(); startLongPress(); });
    btn.addEventListener('mouseup', cancelLongPress);
    btn.addEventListener('mouseleave', cancelLongPress);
    btn.addEventListener('touchend', cancelLongPress);
    btn.addEventListener('touchcancel', cancelLongPress);
  }
});

// Załaduj JSZip
const script = document.createElement('script');
script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
document.head.appendChild(script);

show('0');
</script>
</body>
</html>
